#Generated by a puppet run when running vagrant --provision by the apache module
# so as to have tunnels compatible with the apache numbering

<% sites = scope.lookupvar('sites') -%>
<% oardbsite = scope.lookupvar('oardbsite') -%>

namespace :tunnels do
  desc "Setup tunnels to all api-server-devel machines to get real status"
  task :setup do
<% tunnels="" -%>
<% sites.each_index do |site_index| -%>
<%   unless sites[site_index] == oardbsite -%>
    sh "ssh -NL 800<%= site_index+1 %>:localhost:8000 -L 900<%= site_index+1 %>:public.<%= sites[site_index]%>.grid5000.fr:80 api-server-devel.<%= sites[site_index]%>.g5kadmin &"
<%   else -%>
    sh "ssh -NL 800<%= site_index+1 %>:localhost:8000 -L 900<%= site_index+1 %>:public.<%= sites[site_index]%>.grid5000.fr:80 -L 15433:oardb.<%= sites[site_index]%>.grid5000.fr:5432 api-server-devel.<%= sites[site_index]%>.g5kadmin &"
<%   end -%>
<% end -%>
end		 

  desc "Teardow all ssh tunnels"
  task :teardown do
    sh "ps -C 'ssh' -o pid=,args | grep 'NL' | cut -d ' ' -f 2 | xargs kill"
  end	
end